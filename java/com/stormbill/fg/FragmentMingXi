package com.stormbill.stormbill.fg;

import android.support.v4.app.Fragment;
import android.os.Bundle;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ListView;
import android.widget.ProgressBar;
import android.widget.TextView;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;
import java.util.TimeZone;

import com.stormbill.stormbill.bean.Bean;
import com.stormbill.stormbill.adapter.MingXiAdapter;
import com.stormbill.stormbill.R;
import com.stormbill.stormbill.common.Common;
import com.stormbill.stormbill.common_type.IncomeAndPay;
import com.stormbill.stormbill.data_manager.DateInforManager;
import com.stormbill.stormbill.datastructs.ControlCenter;

public class FragmentMingXi extends Fragment
{
	private ListView 			mListView;
	private MingXiAdapter 		mAdapter;
	private LayoutInflater 		mInflater;
	private View				mHeaderView;
	private View 				mFooterView;
	private View				mSearchView;
	private View				mTitleView;
	private ProgressBar 		mProgressBar;
	private int					mCurProgress;
	private TextView			mTvPaymoney;
	private TextView			mTvIncomeMoney;

	@Override
	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)
	{
		mInflater = inflater;
		return inflater.inflate(R.layout.fg_mingxi, container, false);
	}

	@Override
	public void onViewCreated(View view, Bundle savedInstanceState)
	{
		super.onViewCreated(view, savedInstanceState);
		initViews(view);
		initDatas();
		initEvents();
	}

	@Override
	public void onHiddenChanged(boolean hidden)
	{
		if(!hidden)
		{
			Log.d("hehe", "onHiddenChanged");
			mAdapter.notifyDataSetChanged();

			setPayAndIncome();
		}
	}

	private void initViews(View view)
	{
		mListView = (ListView)view.findViewById(R.id.fg_mingxi_listView);

		mSearchView = view.findViewById(R.id.id_fg_search);
		mTitleView = view.findViewById(R.id.id_fg_title);

		mHeaderView = mInflater.inflate(R.layout.fg_mingxi_item_header, mListView, false);
		mFooterView = mInflater.inflate(R.layout.fg_mingxi_item_footer, mListView, false);

		mListView.addHeaderView(mHeaderView);
		mListView.addFooterView(mFooterView);

		mProgressBar = (ProgressBar)view.findViewById(R.id.id_progressbar);

		mTvPaymoney = (TextView)view.findViewById(R.id.id_top_textView_expenditure_money);
		mTvIncomeMoney = (TextView)view.findViewById(R.id.id_top_textView_income_money);
	}

	private void initDatas()
	{
		mCurProgress = 0;

		mAdapter = new MingXiAdapter(mInflater.getContext() ,R.layout.fg_mingxi_item, ControlCenter.GetRecordItemDetails());

		setCurProgress(50);

		setPayAndIncome();
	}

	private void initEvents()
	{
		mListView.setAdapter(mAdapter);
		mAdapter.notifyDataSetChanged();
		mListView.setOverScrollMode(View.OVER_SCROLL_NEVER);// 去掉回弹阴影效果
	}

	public void setPayAndIncome()
	{
		Calendar calendar = Calendar.getInstance(TimeZone.getTimeZone("GMT+08:00"));
		IncomeAndPay incomeAndPay =  DateInforManager.GetLastMonthIncomeAndPay(calendar.get(Calendar.YEAR), calendar.get(Calendar.MONTH) + 1);
		mTvPaymoney.setText(String.valueOf(incomeAndPay.dPay));
		mTvIncomeMoney.setText(String.valueOf(incomeAndPay.dIncome));
	}

	private void setCurProgress(int progress)
	{
		mCurProgress = progress;
		mProgressBar.setProgress(mCurProgress);
	}
}
